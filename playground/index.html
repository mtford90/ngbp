<!DOCTYPE html>
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>


</head>
<body>
<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
<div id="player"></div>


<script>

var KEYS_TO_SPLIT = [
    'keywords',
    'fmt_list',
    'fexp',
    'watermark',
    'ad_channel_code_overlay'
];

var INFO_URL = '/youtube/get_video_info?' +
        'hl=en_US&el=detailpage&video_id=';

var FORMATS = {

    '5': {
        container: 'flv',
        resolution: '240p',
        encoding: 'Sorenson H.283',
        profile: null,
        bitrate: '0.25',
        audioEncoding: 'mp3',
        audioBitrate: 64
    },

    '6': {
        container: 'flv',
        resolution: '270p',
        encoding: 'Sorenson H.263',
        profile: null,
        bitrate: '0.8',
        audioEncoding: 'mp3',
        audioBitrate: 64
    },

    '13': {
        container: '3gp',
        resolution: null,
        encoding: 'MPEG-4 Visual',
        profile: null,
        bitrate: '0.5',
        audioEncoding: 'aac',
        audioBitrate: null
    },

    '17': {
        container: '3gp',
        resolution: '144p',
        encoding: 'MPEG-4 Visual',
        profile: 'simple',
        bitrate: '0.05',
        audioEncoding: 'aac',
        audioBitrate: 24
    },

    '18': {
        container: 'mp4',
        resolution: '360p',
        encoding: 'H.264',
        profile: 'baseline',
        bitrate: '0.5',
        audioEncoding: 'aac',
        audioBitrate: 96
    },

    '22': {
        container: 'mp4',
        resolution: '720p',
        encoding: 'H.264',
        profile: 'high',
        bitrate: '2-3',
        audioEncoding: 'aac',
        audioBitrate: 192
    },

    '34': {
        container: 'flv',
        resolution: '360p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.5',
        audioEncoding: 'aac',
        audioBitrate: 128
    },

    '35': {
        container: 'flv',
        resolution: '480p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.8-1',
        audioEncoding: 'aac',
        audioBitrate: 128
    },

    '36': {
        container: '3gp',
        resolution: '240p',
        encoding: 'MPEG-4 Visual',
        profile: 'simple',
        bitrate: '0.175',
        audioEncoding: 'aac',
        audioBitrate: 36
    },

    '37': {
        container: 'mp4',
        resolution: '1080p',
        encoding: 'H.264',
        profile: 'high',
        bitrate: '3-5.9',
        audioEncoding: 'aac',
        audioBitrate: 192
    },

    '38': {
        container: 'mp4',
        resolution: '3072p',
        encoding: 'H.264',
        profile: 'high',
        bitrate: '3.5-5',
        audioEncoding: 'aac',
        audioBitrate: 192
    },

    '43': {
        container: 'webm',
        resolution: '360p',
        encoding: 'VP8',
        profile: null,
        bitrate: '0.5',
        audioEncoding: 'vorbis',
        audioBitrate: 128
    },

    '44': {
        container: 'webm',
        resolution: '480p',
        encoding: 'VP8',
        profile: null,
        bitrate: '1',
        audioEncoding: 'vorbis',
        audioBitrate: 128
    },

    '45': {
        container: 'webm',
        resolution: '720p',
        encoding: 'VP8',
        profile: null,
        bitrate: '2',
        audioEncoding: 'vorbis',
        audioBitrate: 192
    },

    '46': {
        container: 'webm',
        resolution: '1080p',
        encoding: 'vp8',
        profile: null,
        bitrate: null,
        audioEncoding: 'vorbis',
        audioBitrate: 192
    },

    '82': {
        container: 'mp4',
        resolution: '360p',
        encoding: 'H.264',
        profile: '3d',
        bitrate: '0.5',
        audioEncoding: 'aac',
        audioBitrate: 96
    },

    '83': {
        container: 'mp4',
        resolution: '240p',
        encoding: 'H.264',
        profile: '3d',
        bitrate: '0.5',
        audioEncoding: 'aac',
        audioBitrate: 96
    },

    '84': {
        container: 'mp4',
        resolution: '720p',
        encoding: 'H.264',
        profile: '3d',
        bitrate: '2-3',
        audioEncoding: 'aac',
        audioBitrate: 192
    },

    '85': {
        container: 'mp4',
        resolution: '1080p',
        encoding: 'H.264',
        profile: '3d',
        bitrate: '3-4',
        audioEncoding: 'aac',
        audioBitrate: 192
    },

    '100': {
        container: 'webm',
        resolution: '360p',
        encoding: 'VP8',
        profile: '3d',
        bitrate: null,
        audioEncoding: 'vorbis',
        audioBitrate: 128
    },

    '101': {
        container: 'webm',
        resolution: '360p',
        encoding: 'VP8',
        profile: '3d',
        bitrate: null,
        audioEncoding: 'vorbis',
        audioBitrate: 192
    },

    '102': {
        container: 'webm',
        resolution: '720p',
        encoding: 'VP8',
        profile: '3d',
        bitrate: null,
        audioEncoding: 'vorbis',
        audioBitrate: 192
    },

    // DASH (video only)
    '133': {
        container: 'mp4',
        resolution: '240p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.2-0.3',
        audioEncoding: null,
        audioBitrate: null
    },

    '134': {
        container: 'mp4',
        resolution: '360p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.3-0.4',
        audioEncoding: null,
        audioBitrate: null
    },

    '135': {
        container: 'mp4',
        resolution: '480p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.5-1',
        audioEncoding: null,
        audioBitrate: null
    },

    '136': {
        container: 'mp4',
        resolution: '720p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '1-1.5',
        audioEncoding: null,
        audioBitrate: null
    },

    '137': {
        container: 'mp4',
        resolution: '1080p',
        encoding: 'H.264',
        profile: 'high',
        bitrate: '2-3',
        audioEncoding: null,
        audioBitrate: null
    },

    '160': {
        container: 'mp4',
        resolution: '144p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.1',
        audioEncoding: null,
        audioBitrate: null
    },

    '264': {
        container: 'mp4',
        resolution: '1440p',
        encoding: 'H.264',
        profile: 'high',
        bitrate: '4-5',
        audioEncoding: null,
        audioBitrate: null
    },

    // DASH (audio only)
    '139': {
        container: 'mp4',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'aac',
        audioBitrate: 48
    },

    '140': {
        container: 'mp4',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'aac',
        audioBitrate: 128
    },

    '141': {
        container: 'mp4',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'aac',
        audioBitrate: 256
    },

    '171': {
        container: 'webm',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'vorbis',
        audioBitrate: 128
    },

    '172': {
        container: 'webm',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'vorbis',
        audioBitrate: 192
    },

    // Live streaming
    '92': {
        container: 'ts',
        resolution: '240p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.15-0.3',
        audioEncoding: 'aac',
        audioBitrate: 48
    },

    '93': {
        container: 'ts',
        resolution: '480p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.5-1',
        audioEncoding: 'aac',
        audioBitrate: 128
    },

    '94': {
        container: 'ts',
        resolution: '720p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '0.8-1.25',
        audioEncoding: 'aac',
        audioBitrate: 128
    },

    '95': {
        container: 'ts',
        resolution: '1080p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '1.5-3',
        audioEncoding: 'aac',
        audioBitrate: 256
    },

    '96': {
        container: 'ts',
        resolution: '720p',
        encoding: 'H.264',
        profile: 'main',
        bitrate: '2.5-6',
        audioEncoding: 'aac',
        audioBitrate: 256
    },

    '120': {
        container: 'flv',
        resolution: '720p',
        encoding: 'H.264',
        profile: 'Main@L3.1',
        bitrate: '2',
        audioEncoding: 'aac',
        audioBitrate: 128
    },

    '127': {
        container: 'ts',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'aac',
        audioBitrate: 96
    },

    '128': {
        container: 'ts',
        resolution: null,
        encoding: null,
        profile: null,
        bitrate: null,
        audioEncoding: 'aac',
        audioBitrate: 96
    },

    '132': {
        container: 'ts',
        resolution: '240p',
        encoding: 'H.264',
        profile: 'baseline',
        bitrate: '0.15-0.2',
        audioEncoding: 'aac',
        audioBitrate: 48
    },

    '151': {
        container: 'ts',
        resolution: '720p',
        encoding: 'H.264',
        profile: 'baseline',
        bitrate: '0.05',
        audioEncoding: 'aac',
        audioBitrate: 24
    },

    '242': {
        container: 'webm',
        resolution: '240p',
        encoding: 'VP9',
        profile: null,
        bitrate: '0.14',
        audioEncoding: null,
        audioBitrate: null
    },

    '243': {
        container: 'webm',
        resolution: '360p',
        encoding: 'VP9',
        profile: null,
        bitrate: '0.26',
        audioEncoding: null,
        audioBitrate: null
    }

};

function parseQuery(qstr) {
    var query = {};
    var a = qstr.split('&');
    for (var i in a) {
        var b = a[i].split('=');
        query[decodeURIComponent(b[0])] = decodeURIComponent(b[1]);
    }

    return query;
}

function sortFormats(a, b) {
    var ares = a.resolution ? parseInt(a.resolution.slice(0, -1), 10) : 0;
    var bres = b.resolution ? parseInt(b.resolution.slice(0, -1), 10) : 0;
    var aabitrate = a.audioBitrate || 0;
    var babitrate = b.audioBitrate || 0;
    var afeats = ~~!!ares * 2 + ~~!!aabitrate;
    var bfeats = ~~!!bres * 2 + ~~!!babitrate;

    if (afeats === bfeats) {
        if (ares === bres) {
            var abitrate, bbitrate, s;
            if (a.bitrate) {
                s = a.bitrate.split('-');
                abitrate = parseFloat(s[s.length - 1], 10);
            } else {
                abitrate = 0;
            }
            if (b.bitrate) {
                s = b.bitrate.split('-');
                bbitrate = parseFloat(s[s.length - 1], 10);
            } else {
                bbitrate = 0;
            }
            if (abitrate === bbitrate) {
                return babitrate - aabitrate;
            } else {
                return bbitrate - abitrate;
            }
        } else {
            return bres - ares;
        }
    } else {
        return bfeats - afeats;
    }
}

function parseFormats(info) {
    var formats = [];
    if (info.url_encoded_fmt_stream_map) {
        formats = formats
                .concat(info.url_encoded_fmt_stream_map.split(','));
    }
    if (info.adaptive_fmts) {
        formats = formats.concat(info.adaptive_fmts.split(','));
    }

    formats = formats
            .map(function (format) {
                var data = parseQuery(format);
                if (data.conn && data.conn.indexOf('rtmp') === 0) {
                    data.rtmp = true;
                }

                var meta = FORMATS[data.itag];
                if (!meta) {
                    console.warn('No format metadata for itag ' + data.itag + ' found');
                }

                _.extend(data, meta);

                return data;
            });
    delete info.url_encoded_fmt_stream_map;
    delete info.adaptive_fmts;

    formats.sort(sortFormats);
    return formats;
}

function getLinkArray(data) {

    var urls = [];


    var info = parseQuery(data);

    // Split some keys by commas.
    KEYS_TO_SPLIT.forEach(function (key) {
        if (!info[key]) return;
        info[key] = info[key]
                .split(',')
                .filter(function (v) {
                    return v !== '';
                });
    });

    // Convert some strings to javascript numbers and booleans.
    Object.keys(info).forEach(function (key) {
        var val = info[key];
        var intVal = parseInt(val, 10);
        var floatVal = parseFloat(val, 10);

        if (intVal.toString() === val) {
            val = intVal;
        } else if (floatVal.toString() === val) {
            val = floatVal;
        } else if (val === 'True') {
            val = true;
        } else if (val === 'False') {
            val = false;
        }
        info[key] = val;
    });

    if (info.fmt_list) {
        info.fmt_list = info.fmt_list.map(function (format) {
            return format.split('/');
        });
    } else {
        info.fmt_list = [];
    }

    info.formats = parseFormats(info);

    if (info.video_verticals) {
        info.video_verticals = info.video_verticals
                .slice(1, -1)
                .split(', ')
                .filter(function (val) {
                    return val !== '';
                })
                .map(function (val) {
                    return parseInt(val, 10);
                })
        ;
    }


    console.log(info);
    return  info;

}


function getVideo(youtube_video_id) {
    var id = "b4VsluhWVh8";
    id = youtube_video_id;
    $.ajax({
        url: INFO_URL + id,
        dataType: "text"
    }).done(function (data) {
        var urls = getLinkArray(data);
    });
}
</script>

<script>
    $(document).ready(function () {
        getVideo('M7lc1UVf-VE');
    });
</script>

<!--<script>-->
<!--// 2. This code loads the IFrame Player API code asynchronously.-->
<!--var tag = document.createElement('script');-->

<!--tag.src = "https://www.youtube.com/iframe_api";-->
<!--var firstScriptTag = document.getElementsByTagName('script')[0];-->
<!--firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);-->

<!--// 3. This function creates an <iframe> (and YouTube player)-->
<!--//    after the API code downloads.-->
<!--var player;-->
<!--function onYouTubeIframeAPIReady() {-->
<!--player = new YT.Player('player', {-->
<!--height: '390',-->
<!--width: '640',-->
<!--videoId: 'M7lc1UVf-VE',-->
<!--events: {-->
<!--'onReady': onPlayerReady,-->
<!--'onStateChange': onPlayerStateChange-->
<!--}-->
<!--});-->

<!--}-->

<!--var outerevent;-->

<!--// 4. The API will call this function when the video player is ready.-->
<!--function onPlayerReady(event) {-->
<!--event.target.playVideo();-->
<!--outerevent = event;-->
<!--}-->

<!--// 5. The API calls this function when the player's state changes.-->
<!--//    The function indicates that when playing a video (state=1),-->
<!--//    the player should play for six seconds and then stop.-->
<!--var done = false;-->
<!--function onPlayerStateChange(event) {-->
<!--if (event.data == YT.PlayerState.PLAYING && !done) {-->
<!--setTimeout(stopVideo, 6000);-->
<!--done = true;-->
<!--}-->
<!--}-->
<!--function stopVideo() {-->
<!--player.stopVideo();-->
<!--}-->
<!--</script>-->

<div id="xxx"></div>
</body>
</html>